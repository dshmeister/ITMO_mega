# ITMO Query Extraction API

## üìå –û–ø–∏—Å–∞–Ω–∏–µ
–≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –±–æ—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–º –ò–¢–ú–û. –û–Ω —Å–æ—á–µ—Ç–∞–µ—Ç –≤ —Å–µ–±–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –¥–≤–∏–∂–æ–∫ Tavily –∏ –º–æ—â–Ω—É—é —è–∑—ã–∫–æ–≤—É—é –º–æ–¥–µ–ª—å Qwen-14B (–∑–∞–ø—É—â–µ–Ω–Ω—É—é –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ) –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–Ω—ã—Ö –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.

### üî• –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- **–ü–æ–∏—Å–∫ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Tavily API –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.
- **–ú–æ—â–Ω—ã–π LLM-–∞–≥–µ–Ω—Ç**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª–æ–∫–∞–ª—å–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–º Qwen-14B –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ.
- **REST API**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ FastAPI –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∏ —É–¥–æ–±–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.
- **Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è**: –ü—Ä–æ—Å—Ç–∞—è —Ä–∞–∑–≤–µ—Ä—Ç–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `Docker` –∏ `docker-compose`.
- **CI/CD**: –í –¥–∞–Ω–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ CI/CD –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω GitLab CI/CD –ø–∞–π–ø–ª–∞–π–Ω, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è GitLab Runner).

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

üìÇ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞**
```
ITMO_mega/
‚îÇ‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api_v1/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tickets/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ views.py  # –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ API
‚îÇ   ‚îÇ‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authorization.py  # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm_config/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prompts.py  # –®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base_model.py  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑–æ–≤–æ–π –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.py  # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas.py  # –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ö–µ–º API
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ instance.py  # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏ LLM –∏ –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm_engine.py  # –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Qwen-14B
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ search_engine.py  # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Tavily API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils.py  # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
‚îÇ‚îÄ‚îÄ main.py  # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ‚îÄ‚îÄ .env  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
‚îÇ‚îÄ‚îÄ docker-compose.yml
‚îÇ‚îÄ‚îÄ Dockerfile
‚îÇ‚îÄ‚îÄ .gitlab-ci.yml  # CI/CD –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏)
‚îÇ‚îÄ‚îÄ README.md
```


## üì• –í—Ö–æ–¥–Ω—ã–µ –∏ –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### üîπ –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (POST `/api/request`)
```json
{
  "query": "–í –∫–∞–∫–æ–º –≥–æ–¥—É –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –ò–¢–ú–û –±—ã–ª –≤–∫–ª—é—á—ë–Ω –≤ —á–∏—Å–ª–æ –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤ –†–æ—Å—Å–∏–∏?\n1. 2007\n2. 2009\n3. 2011\n4. 2015",
  "id": 2
}
```
- **query** *(string)* ‚Äî —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ —Å –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–∞.
- **id** *(integer)* ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞.

### üîπ –í—ã—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
```json
{
  "id": 2,
  "answer": 2,
  "reasoning": "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –ò–¢–ú–û –±—ã–ª –≤–∫–ª—é—á—ë–Ω –≤ —á–∏—Å–ª–æ –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤ –†–æ—Å—Å–∏–∏ –≤ 2009 –≥–æ–¥—É. –≠—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–∞ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∏ –Ω–∞—É–∫–∏ –†–§.",
  "sources": [
    "https://www.itmo.ru",
    "https://–º–∏–Ω–æ–±—Ä–Ω–∞—É–∫–∏.—Ä—Ñ"
  ]
}
```
- **id** *(integer)* ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞.
- **answer** *(integer|null)* ‚Äî –Ω–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ), –∏–Ω–∞—á–µ `null`.
- **reasoning** *(string)* ‚Äî –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞.
- **sources** *(list of strings)* ‚Äî —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫
### 1. ‚ö° –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- Python 3.10+
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `pip`
- –õ–æ–∫–∞–ª—å–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π Qwen-14B

#### üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
pip install -r requirements.txt
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
–î–ª—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `.env` –∏ —É–∫–∞–∑–∞—Ç—å –≤ –Ω–µ–º —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```env
LLM_HOST_URL="http://localhost:4000/v1/chat/completions"  # URL —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ LLM-—Å–µ—Ä–≤–µ—Ä–∞
MODEL_NAME="qwen-14b"  # –ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –º–æ–¥–µ–ª–∏
API_KEY="your_tavily_api_key"  # API –∫–ª—é—á –¥–ª—è Tavily
BEARER_TOKEN="your_secret_token"  # –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è API
```

–≠—Ç–æ—Ç —Ñ–∞–π–ª –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ `.gitignore`).

#### ‚ñ∂ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
```bash
python main.py
```

### 2. üê≥ –ó–∞–ø—É—Å–∫ —Å Docker
**–®–∞–≥ 1:** –°–æ–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞–∑ Docker
```bash
docker build -t query_extraction .
```

**–®–∞–≥ 2:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
```bash
docker-compose up -d
```

**API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É:** `http://localhost:13001/api/request`


## üöÄ –ó–∞–ø—É—Å–∫ LLM —Å vLLM

### üîπ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ —Å Hugging Face
```bash
pip install vllm
huggingface-cli download Qwen/Qwen-14B --local-dir ./models/qwen-14b
```

### üîπ Dockerfile –¥–ª—è vLLM
–°–æ–∑–¥–∞–π—Ç–µ `Dockerfile`:
```dockerfile
FROM python:3.10-slim

WORKDIR /app

RUN pip install vllm

COPY models/qwen-14b /models/qwen-14b

CMD ["python3", "-m", "vllm.entrypoints.api_server", "--model", "/models/qwen-14b"]
```

### üîπ –ó–∞–ø—É—Å–∫ vLLM —Å Docker Compose
–°–æ–∑–¥–∞–π—Ç–µ `docker-compose.yml`:
```yaml
version: '3.9'
services:
  vllm-server:
    build: .
    container_name: vllm_qwen
    volumes:
      - ./models/qwen-14b:/models/qwen-14b
    ports:
      - "4000:4000"
```
–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
```bash
docker-compose up -d
```

## üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx –∏ DNS
### üîπ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–æ–º–µ–Ω–∞
–ß—Ç–æ–±—ã –≤–∞—à —Å–µ—Ä–≤–∏—Å –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è, –≤–∞–º –Ω—É–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–º–µ–Ω —É –ª—é–±–æ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞. –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å `A-–∑–∞–ø–∏—Å—å`, —É–∫–∞–∑—ã–≤–∞—é—â—É—é –Ω–∞ IP-–∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.

### üîπ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx
–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx (`/etc/nginx/sites-available/itmo_query`):
```nginx
server {
    listen 80;
    server_name itmo-query.example.com;

    location / {
        proxy_pass http://localhost:13001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```
–ê–∫—Ç–∏–≤–∞—Ü–∏—è:
```bash
ln -s /etc/nginx/sites-available/itmo_query /etc/nginx/sites-enabled/
systemctl restart nginx
```

## ‚úç –ê–≤—Ç–æ—Ä
**–í–æ–ª–æ—Å–Ω–∏–∫–æ–≤ –ö–∏—Ä–∏–ª–ª**, Jun+ MLOps

üéØ **–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é :)))) GL HF!** üöÄ



